<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoTrace ‚Äì Cyber Intelligence Footprint Visualizer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{--bg:#050a0e;--surface:#0a1520;--surface2:#0f1f30;--border:#1a3a55;--accent:#00d4ff;--accent2:#00ff88;--danger:#ff4060;--warn:#ffb700;--safe:#00e676;--text:#c8e4f7;--muted:#4a7a9b;--mono:'Share Tech Mono',monospace;--ui:'Rajdhani',sans-serif;--glow:0 0 20px rgba(0,212,255,.4);--glow-g:0 0 20px rgba(0,255,136,.4);--glow-r:0 0 20px rgba(255,64,96,.5);--r:10px}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text);font-family:var(--ui);font-size:16px;min-height:100vh;overflow-x:hidden}
    body::before{content:'';position:fixed;inset:0;z-index:999;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none}
    .grid-bg{position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(0,80,160,.05) 1px,transparent 1px),linear-gradient(90deg,rgba(0,80,160,.05) 1px,transparent 1px);background-size:44px 44px;pointer-events:none}
    .wrap{position:relative;z-index:1;max-width:1360px;margin:0 auto;padding:0 clamp(1rem,4vw,2rem)}
    header{display:flex;flex-wrap:wrap;align-items:center;gap:1rem;padding:clamp(1.2rem,4vw,2.5rem) 0 1.2rem;border-bottom:1px solid var(--border);margin-bottom:1.5rem}
    .logo-row{display:flex;align-items:center;gap:.8rem}
    .logo-icon{width:46px;height:46px;border:2px solid var(--accent);border-radius:10px;display:grid;place-items:center;font-size:1.5rem;box-shadow:var(--glow);animation:pulse 2.5s ease-in-out infinite;flex-shrink:0}
    @keyframes pulse{0%,100%{box-shadow:var(--glow)}50%{box-shadow:0 0 40px rgba(0,212,255,.7)}}
    .logo-text h1{font-family:var(--mono);font-size:clamp(1.4rem,5vw,1.9rem);color:var(--accent);letter-spacing:.05em;line-height:1}
    .logo-text p{font-size:.72rem;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;margin-top:.25rem}
    .hbadges{margin-left:auto;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    .badge{padding:.22rem .65rem;border:1px solid var(--border);border-radius:4px;font-family:var(--mono);font-size:.68rem;color:var(--muted);letter-spacing:.1em;white-space:nowrap}
    .badge.live{border-color:var(--accent2);color:var(--accent2)}
    .badge.live::before{content:'‚óè ';animation:blink 1.2s step-start infinite}
    @keyframes blink{50%{opacity:0}}
    .main-grid{display:grid;gap:1.25rem;grid-template-columns:1fr;grid-template-areas:"scan" "result" "map" "history"}
    @media(min-width:860px){.main-grid{grid-template-columns:360px 1fr;grid-template-rows:auto auto 1fr;grid-template-areas:"scan map" "result map" "history history"}}
    .area-scan{grid-area:scan}.area-result{grid-area:result}.area-map{grid-area:map}.area-history{grid-area:history}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:clamp(.9rem,2.5vw,1.4rem);position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.45}
    .card-title{font-family:var(--mono);font-size:.68rem;letter-spacing:.22em;text-transform:uppercase;color:var(--accent);margin-bottom:1.1rem;display:flex;align-items:center;gap:.5rem}
    .card-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent)}
    .input-wrap{position:relative;margin-bottom:.9rem}
    .input-prefix{position:absolute;left:.8rem;top:50%;transform:translateY(-50%);font-family:var(--mono);font-size:.85rem;color:var(--muted);pointer-events:none;user-select:none}
    #domainInput{width:100%;padding:.85rem 1rem .85rem 2.6rem;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-family:var(--mono);font-size:.95rem;outline:none;transition:border-color .2s,box-shadow .2s}
    #domainInput:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,212,255,.1)}
    #domainInput::placeholder{color:var(--muted)}
    #scanBtn{width:100%;padding:.88rem;background:transparent;border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:var(--mono);font-size:.95rem;letter-spacing:.14em;cursor:pointer;position:relative;overflow:hidden;transition:background .2s,box-shadow .2s}
    #scanBtn:hover:not(:disabled){background:rgba(0,212,255,.08);box-shadow:var(--glow)}
    #scanBtn:disabled{opacity:.5;cursor:not-allowed}
    #scanBtn.scanning::after{content:'';position:absolute;top:0;left:-100%;width:80%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,212,255,.22),transparent);animation:sweep 1.1s ease-in-out infinite}
    @keyframes sweep{to{left:130%}}
    .quick-wrap{margin-top:1rem}.quick-label{font-size:.68rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;margin-bottom:.5rem}
    .chips{display:flex;flex-wrap:wrap;gap:.4rem}
    .chip{padding:.28rem .65rem;border:1px solid var(--border);border-radius:20px;font-family:var(--mono);font-size:.73rem;color:var(--muted);cursor:pointer;background:none;transition:all .2s}
    .chip:hover{border-color:var(--accent);color:var(--accent)}
    .placeholder{border:1px dashed var(--border);border-radius:8px;padding:1.5rem;text-align:center;font-family:var(--mono);font-size:.82rem;color:var(--muted);line-height:1.7}
    .result-grid{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;animation:fadeUp .35s ease}
    @media(max-width:480px){.result-grid{grid-template-columns:1fr}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .field{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.7rem .85rem}
    .field.full{grid-column:1/-1}
    .field-label{font-size:.6rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:.3rem}
    .field-value{font-family:var(--mono);font-size:clamp(.78rem,2vw,.9rem);color:var(--text);word-break:break-all}
    .threat-badge{display:inline-flex;align-items:center;gap:.4rem;margin-top:.45rem;padding:.28rem .8rem;border-radius:20px;font-family:var(--mono);font-size:.82rem;font-weight:700;letter-spacing:.08em;border:1px solid}
    .t-safe{color:var(--safe);border-color:var(--safe);background:rgba(0,230,118,.1);box-shadow:var(--glow-g)}
    .t-suspicious{color:var(--warn);border-color:var(--warn);background:rgba(255,183,0,.1)}
    .t-high-risk{color:var(--danger);border-color:var(--danger);background:rgba(255,64,96,.1);box-shadow:var(--glow-r)}
    .t-unknown{color:var(--muted);border-color:var(--border)}
    .score-track{height:5px;background:var(--surface);border:1px solid var(--border);border-radius:3px;overflow:hidden;margin-top:.55rem}
    .score-fill{height:100%;border-radius:3px;width:0;transition:width 1s ease}
    .sf-safe{background:var(--safe)}.sf-suspicious{background:var(--warn)}.sf-high-risk{background:var(--danger)}
    .score-lbl{font-family:var(--mono);font-size:.68rem;color:var(--muted);margin-top:.3rem}
    .reasons{list-style:none;margin-top:.6rem}
    .reasons li{font-size:.78rem;color:var(--muted);padding:.22rem 0;border-bottom:1px solid rgba(26,58,85,.4);display:flex;gap:.45rem}
    .reasons li:last-child{border-bottom:none}
    .reasons li::before{content:'‚Ä∫';color:var(--accent);flex-shrink:0}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:.4rem}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error-box{background:rgba(255,64,96,.08);border:1px solid var(--danger);border-radius:8px;padding:.75rem 1rem;font-family:var(--mono);font-size:.82rem;color:var(--danger);display:flex;gap:.5rem;align-items:flex-start}
    /* MAP ‚Äî explicit height fixes blank map bug */
    .area-map .card{padding-bottom:0}
    #map{width:100%;height:400px;border-radius:0 0 var(--r) var(--r);display:block}
    @media(min-width:860px){ #map{height:520px}}
    .leaflet-tile-pane{filter:invert(1) hue-rotate(200deg) saturate(.75) brightness(.65)}
    .leaflet-control-attribution{display:none}
    .leaflet-popup-content-wrapper{background:var(--surface);border:1px solid var(--accent);color:var(--text);font-family:var(--mono);font-size:.8rem;border-radius:6px}
    .leaflet-popup-tip{background:var(--surface)}
    .history-head{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem}
    .history-head .card-title{margin-bottom:0}
    #clearBtn{padding:.3rem .75rem;background:none;border:1px solid rgba(255,64,96,.4);border-radius:6px;color:var(--danger);font-family:var(--mono);font-size:.68rem;letter-spacing:.1em;cursor:pointer;transition:all .2s}
    #clearBtn:hover{background:rgba(255,64,96,.08);border-color:var(--danger)}
    .tbl-wrap{overflow-x:auto;border-radius:8px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;font-size:.8rem;white-space:nowrap}
    thead tr{background:var(--surface2)}
    th{font-family:var(--mono);font-size:.62rem;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;padding:.7rem 1rem;text-align:left;font-weight:400;border-bottom:1px solid var(--border)}
    td{padding:.6rem 1rem;border-bottom:1px solid rgba(26,58,85,.35);font-family:var(--mono);font-size:.78rem}
    tbody tr:hover{background:var(--surface2)}
    tbody tr:last-child td{border-bottom:none}
    .td-domain{color:var(--accent);cursor:pointer;max-width:160px;overflow:hidden;text-overflow:ellipsis}
    .td-domain:hover{text-decoration:underline}
    .pill{padding:.14rem .5rem;border-radius:12px;font-size:.68rem;font-weight:700;letter-spacing:.05em}
    .p-safe{background:rgba(0,230,118,.12);color:var(--safe)}.p-suspicious{background:rgba(255,183,0,.12);color:var(--warn)}.p-high-risk{background:rgba(255,64,96,.12);color:var(--danger)}.p-unknown{background:rgba(74,122,155,.12);color:var(--muted)}
    .empty-row td{text-align:center;padding:2rem;color:var(--muted);font-size:.82rem}
    footer{border-top:1px solid var(--border);margin-top:1rem;padding:1.25rem 0 2rem;display:flex;flex-wrap:wrap;gap:.5rem;justify-content:space-between;font-family:var(--mono);font-size:.68rem;color:var(--muted)}
    footer a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
<div class="grid-bg"></div>
<div class="wrap">

  <header>
    <div class="logo-row">
      <div class="logo-icon">üåê</div>
      <div class="logo-text">
        <h1>GeoTrace</h1>
        <p>Cyber Intelligence &amp; Footprint Visualizer</p>
      </div>
    </div>
    <div class="hbadges">
      <span class="badge live">OSINT ACTIVE</span>
      <span class="badge">v2.0</span>
      <span class="badge" id="clock">--:--:--</span>
    </div>
  </header>

  <div class="main-grid">

    <div class="card area-scan">
      <div class="card-title">‚åñ TARGET ACQUISITION</div>
      <div class="input-wrap">
        <span class="input-prefix">‚Ä∫_</span>
        <input type="text" id="domainInput" placeholder="example.com"
          autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
      </div>
      <button id="scanBtn" onclick="runScan()">INITIATE SCAN</button>
      <div class="quick-wrap">
        <div class="quick-label">Quick targets</div>
        <div class="chips">
          <button class="chip" onclick="setDomain('google.com')">google.com</button>
          <button class="chip" onclick="setDomain('github.com')">github.com</button>
          <button class="chip" onclick="setDomain('cloudflare.com')">cloudflare.com</button>
          <button class="chip" onclick="setDomain('wikipedia.org')">wikipedia.org</button>
        </div>
      </div>
    </div>

    <div class="card area-result">
      <div class="card-title">‚óà SCAN INTELLIGENCE</div>
      <div id="resultBox">
        <div class="placeholder">Enter a domain above and hit<br><strong>INITIATE SCAN</strong> to see results here.</div>
      </div>
    </div>

    <div class="card area-map">
      <div class="card-title" style="padding:0 0 .8rem;margin-bottom:0">‚óâ GLOBAL TRIANGULATION</div>
      <div id="map"></div>
    </div>

    <div class="card area-history">
      <div class="history-head">
        <div class="card-title" style="margin-bottom:0">‚ñ§ MISSION LOGS</div>
        <button id="clearBtn" onclick="clearHistory()">CLEAR ALL</button>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Domain</th><th>IP Address</th>
              <th>Location</th><th>ISP</th><th>Threat</th><th>Score</th><th>Time (UTC)</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr class="empty-row"><td colspan="8">No scans recorded yet.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <footer>
    <span>GeoTrace ¬© 2025 ¬∑ <a href="https://github.com/Abhijit9999908/GeoTrace" target="_blank">GitHub</a> ¬∑ Built by Abhijit Rathod</span>
    <span>Educational &amp; OSINT use only ‚Äî no active scanning performed.</span>
  </footer>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const $ = id => document.getElementById(id);
const esc = s => String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* Clock */
const tickClock=()=>{ $('clock').textContent=new Date().toLocaleTimeString('en-US',{hour12:false}); };
tickClock(); setInterval(tickClock,1000);

function setDomain(d){ $('domainInput').value=d; $('domainInput').focus(); }

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ explicit height in CSS means Leaflet always gets a real size */
const map = L.map('map',{zoomControl:true,attributionControl:false}).setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
let mapMarker=null;

function pinOnMap(lat,lon,label){
  if(mapMarker) map.removeLayer(mapMarker);
  const icon=L.divIcon({className:'',html:`<div style="width:14px;height:14px;background:#00d4ff;border-radius:50%;border:3px solid #fff;box-shadow:0 0 16px rgba(0,212,255,.9)"></div>`,iconSize:[14,14],iconAnchor:[7,7]});
  mapMarker=L.marker([lat,lon],{icon}).addTo(map).bindPopup(`<strong>${label}</strong>`).openPopup();
  map.flyTo([lat,lon],6,{duration:1.4});
}

/* Recalculate after layout (belt-and-suspenders) */
window.addEventListener('load',()=>{ setTimeout(()=>map.invalidateSize(),300); });

/* ‚îÄ‚îÄ Threat helpers ‚îÄ‚îÄ */
function tCls(l){ l=(l||'').toLowerCase(); if(l==='safe')return 't-safe'; if(l==='suspicious')return 't-suspicious'; if(l.includes('high')||l.includes('risk'))return 't-high-risk'; return 't-unknown'; }
function pCls(l){ l=(l||'').toLowerCase(); if(l==='safe')return 'p-safe'; if(l==='suspicious')return 'p-suspicious'; if(l.includes('high')||l.includes('risk'))return 'p-high-risk'; return 'p-unknown'; }
function sCls(s){ if(s>=60)return 'sf-high-risk'; if(s>=30)return 'sf-suspicious'; return 'sf-safe'; }
function tEmoji(l){ l=(l||'').toLowerCase(); if(l==='safe')return 'üü¢'; if(l==='suspicious')return 'üü°'; if(l.includes('high')||l.includes('risk'))return 'üî¥'; return '‚ö™'; }

/* ‚îÄ‚îÄ SCAN ‚îÄ‚îÄ */
async function runScan(){
  const domain=$('domainInput').value.trim();
  if(!domain){ $('domainInput').focus(); return; }
  const btn=$('scanBtn');
  btn.disabled=true; btn.classList.add('scanning'); btn.textContent='SCANNING...';
  $('resultBox').innerHTML=`<div class="placeholder"><span class="spinner"></span> Resolving <strong>${esc(domain)}</strong>‚Ä¶</div>`;
  try{
    const res=await fetch('/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain})});
    const data=await res.json();
    if(!res.ok||data.error){ showErr(data.error||`Server error HTTP ${res.status}`); }
    else{
      renderResult(data);
      if(data.lat!=null&&data.lon!=null) pinOnMap(data.lat,data.lon,data.domain);
      loadHistory();
    }
  }catch(e){ showErr('Network error ‚Äî could not reach the server.'); }
  finally{ btn.disabled=false; btn.classList.remove('scanning'); btn.textContent='INITIATE SCAN'; }
}

function showErr(msg){
  $('resultBox').innerHTML=`<div class="error-box"><span>‚ö†</span><span>${esc(msg)}</span></div>`;
}

function renderResult(d){
  const sc=d.threat_score??0;
  const level=d.threat_level||'UNKNOWN';
  const reasons=Array.isArray(d.threat_reasons)?d.threat_reasons:[];
  const loc=[d.city,d.region,d.country].filter(Boolean).join(', ')||'‚Äî';
  $('resultBox').innerHTML=`
    <div class="result-grid">
      <div class="field"><div class="field-label">Target Domain</div><div class="field-value">${esc(d.domain)}</div></div>
      <div class="field"><div class="field-label">IP Node</div><div class="field-value">${esc(d.ip||'‚Äî')}</div></div>
      <div class="field"><div class="field-label">Origin</div><div class="field-value">${esc(loc)}</div></div>
      <div class="field"><div class="field-label">Coordinates</div><div class="field-value">${d.lat!=null?d.lat.toFixed(4)+', '+d.lon.toFixed(4):'‚Äî'}</div></div>
      <div class="field full"><div class="field-label">ISP / Org</div><div class="field-value">${esc(d.isp||'‚Äî')}${d.org&&d.org!==d.isp?' ¬∑ '+esc(d.org):''}</div></div>
      <div class="field full">
        <div class="field-label">Threat Classification</div>
        <div><span class="threat-badge ${tCls(level)}">${tEmoji(level)} ${esc(level)}</span></div>
        <div class="score-track"><div id="scoreBar" class="score-fill ${sCls(sc)}" style="width:0%"></div></div>
        <div class="score-lbl">Risk score: ${sc} / 100</div>
        ${reasons.length?`<ul class="reasons">${reasons.map(r=>`<li>${esc(r)}</li>`).join('')}</ul>`:''}
      </div>
    </div>`;
  requestAnimationFrame(()=>requestAnimationFrame(()=>{ const b=$('scoreBar'); if(b) b.style.width=sc+'%'; }));
}

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
async function loadHistory(){
  try{ const res=await fetch('/history?limit=50'); const rows=await res.json(); renderHistory(Array.isArray(rows)?rows:[]); }catch{}
}

function renderHistory(rows){
  const tbody=$('historyBody');
  if(!rows.length){ tbody.innerHTML='<tr class="empty-row"><td colspan="8">No scans recorded yet.</td></tr>'; return; }
  tbody.innerHTML=rows.map((r,i)=>{
    const loc=[r.city,r.country].filter(Boolean).join(', ')||'‚Äî';
    const ts=(r.scanned_at||'').replace('T',' ').slice(0,19)||'‚Äî';
    return `<tr>
      <td>${rows.length-i}</td>
      <td class="td-domain" title="${esc(r.domain)}" onclick="setDomain('${esc(r.domain)}')">${esc(r.domain)}</td>
      <td>${esc(r.ip||'‚Äî')}</td>
      <td>${esc(loc)}</td>
      <td>${esc(r.isp||'‚Äî')}</td>
      <td><span class="pill ${pCls(r.threat_level)}">${esc(r.threat_level||'?')}</span></td>
      <td>${r.threat_score??'‚Äî'}</td>
      <td>${ts}</td>
    </tr>`;
  }).join('');
}

async function clearHistory(){
  if(!confirm('Clear all scan history?')) return;
  try{ await fetch('/history/clear',{method:'DELETE'}); renderHistory([]); }
  catch{ alert('Failed to clear history.'); }
}

loadHistory();
$('domainInput').addEventListener('keydown',e=>{ if(e.key==='Enter') runScan(); });
</script>
</body>
</html>
    
